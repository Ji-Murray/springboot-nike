<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/css/head.css">
  <link rel="stylesheet" href="/css/middle.css">
  <link rel="stylesheet" href="/css/command.css">
  <link rel="stylesheet" href="/css/bottom.css">
  <link rel="stylesheet" href="/css/iconfont/iconfont.css" />
  <link rel="stylesheet" href="/css/iconfont2/iconfont.css" />
  <SCRIPT src="//at.alicdn.com/t/c/font_4809456_9sertybmtm5.js"></SCRIPT>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <title>购物车</title>
</head>
<style type="text/css">
  .icon {
    width: 6em; height: 2em;
    vertical-align: -0.15em;
    fill: currentColor;
    overflow: hidden;
  }
</style>
<body>
<div class="head" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1001; background-color: #f5f5f5;">
  <div class="left" style="display: flex; align-items: center;">
    <a href="/shouye" style="color: inherit; text-decoration: none;display: flex">
      <div class="iconfont icon-nike" style="margin-left: 20px"></div>
      <div class="iconfont icon-converse" style="margin-left: 23px"></div>
    </a>
  </div>

  <div class="right">
    <nav style="--bs-breadcrumb-divider: '｜';" aria-label="breadcrumb">
      <ol class="breadcrumb">

        <li class="breadcrumb-item"><a style="color: #111111" href="/about">关于我们</a></li>
        <li class="breadcrumb-item"><a style="color: #111111" href="/orderlist">我的订单</a></li>
        <li class="breadcrumb-item" id="userSection">
                        <span th:if="${session.user != null}">
                            欢迎，<span th:text="${session.user.username}"></span>
                            <a href="/logout" style="color: #111111; margin-left: 10px;">退出</a>
                        </span>

          <a th:unless="${session.user != null}" href="/login" style="color: #111111;">登录</a>
        </li>
      </ol>

    </nav>
  </div>
</div>

<div class="head2" style="position: fixed; top: 25px; left: 0; right: 0; z-index: 1000; background-color: white; padding: 10px 0;">
  <div class="head-left">
    <img src="/img/img.png" alt="">
  </div>
  <div class="head-middle">
    <a th:href="@{/products(category='新品')}">新品&潮流</a>
    <a th:href="@{/products(category='男子')}">男子</a>
    <a th:href="@{/products(category='女子')}">女子</a>
    <a th:href="@{/products(category='儿童')}">儿童</a>
  </div>
  <div class="head-right">
    <a href="/chart">
      <svg class="icon" aria-hidden="true">
        <use xlink:href="#icon-gouwuche"></use>
      </svg>
    </a>
    <form class="d-flex" role="search" th:action="@{/search}" method="get">
      <input class="form-control me-2" type="search" name="keyword" placeholder="搜索球衣" aria-label="Search">
      <button class="btn btn-light text-nowrap" type="submit">搜索</button>
    </form>
  </div>
</div>

<div class="container d-flex flex-wrap justify-content-between align-items-start p-3" style="margin-top: 120px;">
  <!-- 商品列表区域 -->
  <div class="cart-items" style="width: 60%; min-width: 300px;">
    <div th:each="item : ${cartItems}" class="card mb-3" style="max-width: 100%;">
      <div class="row g-0 h-100">
        <!-- 图片区域 - 固定宽高比 -->
        <div class="col-md-4 position-relative" style="min-height: 150px; aspect-ratio: 1/1;">
          <img th:if="${item.product != null}" 
               th:src="${item.product.imageUrl}"
               class="img-fluid rounded-start h-100 w-100 object-fit-cover"
               th:alt="${item.product.name}"
               style="position: absolute; top: 0; left: 0;">
          <div th:unless="${item.product != null}" class="d-flex align-items-center justify-content-center h-100">
            <span class="text-muted">商品已下架</span>
          </div>
        </div>

        <!-- 商品信息区域 -->
        <div class="col-md-8 d-flex flex-column">
          <div class="card-body d-flex flex-column h-100 p-3">
            <h5 class="card-title mb-2" th:text="${item.product != null ? item.product.name : '商品已下架'}">商品名</h5>
            <p class="card-text flex-grow-1 mb-2 small"
               th:text="${item.product != null ? item.product.description : '商品已下架'}"
               style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">

            </p>
            <div class="mb-2">
              <span class="badge bg-light text-dark me-2" th:text="'尺码: ' + ${item.size}">尺码</span>
              <span class="badge bg-light text-dark me-2" th:text="'数量: ' + ${item.quantity}">数量</span>
              <span class="badge bg-light text-dark" th:text="'¥' + ${item.price}">价格</span>
            </div>
            <div class="mt-auto text-end">
              <button class="btn btn-outline-danger btn-sm remove-item"
                      th:data-id="${item.id}"
                      style="width: 80px; cursor: pointer;">
                删除
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 摘要区域 -->
  <div class="summary-card sticky-top" style="width: 35%; min-width: 300px; top: 20px;">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="card-title text-center mb-4">订单摘要</h3>

        <div class="d-flex justify-content-between mb-3">
          <span class="text-muted">商品小计</span>
          <span th:text="'¥' + ${#numbers.formatDecimal(total, 1, 2)}">¥0.00</span>
        </div>

        <div class="d-flex justify-content-between mb-3">
          <span class="text-muted">运费</span>
          <span>¥0.00</span>
        </div>

        <hr>

        <div class="d-flex justify-content-between mb-4">
          <h5>总计</h5>
          <h5 th:text="'¥' + ${#numbers.formatDecimal(total, 1, 2)}">¥0.00</h5>
        </div>

        <button class="btn btn-dark w-100 mb-2 py-2" id="checkoutButton">前往结算</button>
        <button class="btn btn-outline-danger w-100 py-2" id="clearCart">清空购物车</button>
      </div>
    </div>
  </div>
</div>

<script>
$(function() {
    // 删除购物车项
    $(document).on('click', '.remove-item', function() {
        const itemId = $(this).data('id');
        console.log('删除商品ID:', itemId);
        if (confirm('确定要删除这个商品吗？')) {
            $.ajax({
                url: '/cart/remove',
                type: 'POST',
                data: { cartItemId: itemId },
                success: function(response) {
                    console.log('删除成功:', response);
                    alert(response);
                    location.reload();
                },
                error: function(xhr) {
                    console.error('删除失败:', xhr.responseText);
                    alert('删除失败: ' + xhr.responseText);
                }
            });
        }
    });

    // 清空购物车
    $(document).on('click', '#clearCart', function() {
        if (confirm('确定要清空购物车吗？')) {
            $.ajax({
                url: '/cart/clear',
                type: 'POST',
                success: function(response) {
                    alert(response);
                    location.reload();
                },
                error: function(xhr) {
                    alert('清空失败: ' + xhr.responseText);
                }
            });
        }
    });

    // 结算按钮点击事件
    $(document).on('click', '#checkoutButton', function() {
        // 获取购物车中的所有商品
        const cartItems = [];
        $('.cart-items .card').each(function() {
            const item = {
                productId: $(this).find('.remove-item').data('id'),
                size: $(this).find('.badge').first().text().replace('尺码: ', ''),
                quantity: parseInt($(this).find('.badge').eq(1).text().replace('数量: ', ''))
            };
            cartItems.push(item);
        });

        // 为每个商品创建订单
        let successCount = 0;
        let failCount = 0;
        
        cartItems.forEach(function(item) {
            $.ajax({
                url: '/orderlist/create',
                type: 'GET',
                data: {
                    productId: item.productId,
                    size: item.size,
                    quantity: item.quantity
                },
                success: function(response) {
                    successCount++;
                    if (successCount + failCount === cartItems.length) {
                        if (successCount === cartItems.length) {
                            alert('订单创建成功，即将跳转到支付页面');
                            window.location.href = '/orderlist';
                        } else {
                            alert('部分订单创建成功，请查看订单列表');
                            window.location.href = '/orderlist';
                        }
                    }
                },
                error: function(xhr) {
                    failCount++;
                    console.error('订单创建失败:', xhr.responseText);
                    if (successCount + failCount === cartItems.length) {
                        if (successCount > 0) {
                            alert('部分订单创建成功，请查看订单列表');
                        } else {
                            alert('订单创建失败，请重试');
                        }
                        window.location.href = '/orderlist';
                    }
                }
            });
        });
    });
});
</script>

<hr style="border: solid #ccc; margin: 20px 0;">
<div class="bottom">

  <div class="a2">
    <p><small>
      @纪子涵2025 Allright.reserve
    </small>
    </p>
    <p>
      地址：哈尔滨理工大学西区七公寓
    </p>

  </div>

</div>


</body>
</html>